from typing import Sequence

import torch
from torch.fx.passes.shape_prop import ShapeProp
from torch_migraphx.fx.mgx_module import MGXModule
from torch_migraphx.fx.fx2mgx import MGXInterpreter

from .passes.partition import partition, get_partition_inputs
from .utils import print_graph_info


def lower_aten_to_mgx(gm: torch.fx.GraphModule,
                      example_inputs: Sequence[torch.Tensor],
                      **kwargs) -> torch.fx.GraphModule:
    """Lower aten GraphModule generated by dynamo and AOT Autograd to MIGraphX.
       1) Partition the graph into supported and unsupported subgraphs
       2) Lower to each supported subgraph to MIGraphX
       3) Replace original GraphModules with lowered MGXModules

    Args:
        gm (torch.fx.GraphModule): Graph generated by dynamo and aot autograd
        example_inputs (Sequence[torch.Tensor]): Example inputs

    Returns:
        torch.fx.GraphModule: GraphModule contatning MGXModule objects for supported subgraphs
    """
    verbose = kwargs['verbose'] if 'verbose' in kwargs else False
    if verbose:
        print_graph_info('Traced Model', gm, example_inputs)

    partitioned_gm = partition(gm, verbose=verbose)
    for name, mod in partitioned_gm.named_children():
        partition_inputs = get_partition_inputs(partitioned_gm, mod,
                                                example_inputs)
        if verbose:
            print_graph_info(name, mod, partition_inputs)

        mgx_mod = lower_subgraph(mod, partition_inputs, **kwargs)

        setattr(partitioned_gm, name, mgx_mod)

    return partitioned_gm


def lower_subgraph(module: torch.fx.GraphModule,
                   inputs: Sequence[torch.Tensor], **kwargs) -> MGXModule:
    """Lower graph to migraphx module. This graph should only contain supported nodes.

    Args:
        module (torch.fx.GraphModule): Graph to compile in MIGraphX
        inputs (Sequence[torch.Tensor]): Example inputs to the graph

    Returns:
        MGXModule: Callable module that executes graph via MIGraphX
    """

    ShapeProp(module).propagate(*inputs)

    verbose = kwargs['verbose'] if 'verbose' in kwargs else False
    fp16 = kwargs['fp16'] if 'fp16' in kwargs else False

    interpreter = MGXInterpreter(module, inputs, verbose_log=verbose)
    interpreter.run()

    mgx_module = MGXModule(program=interpreter.program,
                           input_names=interpreter.get_input_names(),
                           quantize_fp16=fp16)

    return mgx_module